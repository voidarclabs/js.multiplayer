<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href='https://fonts.googleapis.com/css?family=Varela Round' rel='stylesheet'>
    <link rel="stylesheet" href="index.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/socket.io/socket.io.js"></script>
    <title>Multiplayer Game</title>
</head>
<body>
    <div class="popup" id="logincontainer">
        <input type="text" id="namecontainer">
        <input type="text" id="passcontainer">
        <input type="text" id="colorcontainer">
        <button type="submit"id='submitname'>submit</button>
    </div>
    <div id="gamecontainer">
        
    </div>
    <script>
        const socket = io()
        const isAlphanumeric = str => /^[0-9A-Z]+$/i.test(str);

        var namechosen
        var colorchosen
        var gamer
        var game

        function isValidColor(color) {
            // Create a temporary DOM element
            const tempElement = document.createElement('div');
            // Set the element's color property
            tempElement.style.color = color;
            // Check if the color was applied
            return tempElement.style.color !== '';
        }

        socket.on(`getname`, (callback) => {
            let event = document.getElementById('submitname').addEventListener('click', handlebuttonpress)

            function handlebuttonpress(event) {
                namechosen = document.getElementById('namecontainer').value
                colorchosen = document.getElementById('colorcontainer').value
                passchosen = document.getElementById('passcontainer').value

                if (!isAlphanumeric(namechosen) || document.getElementById(`player-${namechosen}`)) {
                    console.log('empty username')
                } else {
                    if (!isAlphanumeric(colorchosen) || !isValidColor(colorchosen)) {
                        console.log('empty color')
                    } else {
                        socket.emit('requestpass', [namechosen, passchosen], (callback2) => {
                            if (callback2 = 'incorrect') {
                                console.log('incorrect password')
                            }
                            if (callback2 = 'newuser') {
                                handlesucess()
                            }
                            if (callback2 = 'olduser') {

                            }
                        })

                        function handlesuccess() {
                            callback({name: namechosen, color: colorchosen})

                            gamer = `player-${namechosen}`

                            document.getElementById('logincontainer').style.display = 'none'

                            // Initialize movement system
                            setTimeout(() => {
                                setupMovementSystem();
                            }, 50);
                        }
                        
                        
                    }
                    
                }
            }
            
        })

        socket.on('gameupdate', (data) => {
            let type = data[0]
            let info = data[1]
            if (type == 'join') {
                let name = info[0]
                let color = info[1]
                let position = info[2]
                let elementname = document.getElementById(`player-${name}`)
                if (!elementname) {
                    addplayer(name, color, position)
                    console.log(`player ${name} joined`)
                    
                }
            }
            if (type == 'all') {
                document.getElementById('gamecontainer').innerHTML = `` 
            }
            if (type == 'pos') {
                let playername = info[0]
                let newposition = info[1]
                if (newposition && newposition.length === 2) {
                    let player = document.getElementById(`player-${playername}`);

                    if (player) {
                        // Set the CSS grid position
                        player.style.gridColumnStart = newposition[0];
                        player.style.gridRowStart = newposition[1];
                    } else {
                        console.error(`Player element not found: ${playername}`);
                    }
                } else {}
                
            }
        })
        
        function setupMovementSystem() {
            const game = document.getElementById(gamer);

            let movementFunctions = {
                w: { func: moveForward, intervalId: null },
                a: { func: moveLeft, intervalId: null },
                s: { func: moveBackward, intervalId: null },
                d: { func: moveRight, intervalId: null }
            };

            let activeMovement = null;

            // Function to handle keydown event
            function keydownHandler(event) {
                const key = event.key.toLowerCase();
                if (movementFunctions[key] && !activeMovement) {
                    activeMovement = key;
                    movementFunctions[key].func(); // Execute the function immediately

                    const currentPos = {
                        x: game.style.getPropertyValue('grid-column-start'),
                        y: game.style.getPropertyValue('grid-row-start')
                    };

                    socket.emit('clientupdate', ['position', currentPos]);

                    // Start repeating the function every 100ms
                    movementFunctions[key].intervalId = setInterval(() => {
                        movementFunctions[key].func();
                        const currentPos = {
                            x: game.style.getPropertyValue('grid-column-start'),
                            y: game.style.getPropertyValue('grid-row-start')
                        };
                        socket.emit('clientupdate', ['position', currentPos]);
                    }, 100);
                }
            }

            // Function to handle keyup event
            function keyupHandler(event) {
                const key = event.key.toLowerCase();
                if (movementFunctions[key] && activeMovement === key) {
                    clearInterval(movementFunctions[key].intervalId);
                    movementFunctions[key].intervalId = null;
                    activeMovement = null;
                }
            }

            // Add event listeners for keydown and keyup
            document.addEventListener('keydown', keydownHandler);
            document.addEventListener('keyup', keyupHandler);


            // Movement functions
            function moveForward() {
                game.style.gridRow --
            }

            function moveLeft() {
                game.style.gridColumn --
            }

            function moveBackward() {
                game.style.gridRow ++
                if (game.style.gridRow > 30) {game.style.gridRow = 30}
            }

            function moveRight() {
                game.style.gridColumn ++
                if (game.style.gridColumn > 30) {game.style.gridColumn = 30}
            }
}
            

        function addplayer(name, color, position) {
            let player = `<div class="player" id='player-${name}'>
                            <div class="playercolor"></div>
                            <div id='playername-${name}' class="playername">${name}</div>
                        </div>`
                        
            document.getElementById('gamecontainer').innerHTML += player
            let playeringame = document.getElementById(`player-${name}`)
            playeringame.style.backgroundColor = color
            playeringame.style.gridRow = position.y
            playeringame.style.gridColumn = position.x

            let playernameingame = document.getElementById(`playername-${name}`)
            let overflow = playernameingame.scrollWidth
            let gridwidth = document.getElementById('gamecontainer').clientWidth / 30
            let margin = overflow - gridwidth
            playernameingame.style.marginLeft = -margin / 2 + 'px'
        }
    </script>
</body>
</html>